{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ES/Desktop/2025/EstateIQIndia/app/api/state-analysis/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { GoogleGenAI } from \"@google/genai\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { stateName } = await request.json();\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY || '';\r\n\r\n    console.log('üìç State analysis requested for:', stateName);\r\n    console.log('üîë API Key Status:', apiKey ? `Loaded (length: ${apiKey.length})` : '‚ùå EMPTY');\r\n\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: 'API Key missing' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    if (!stateName) {\r\n      return NextResponse.json(\r\n        { error: 'State name is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Initialize GoogleGenAI inside the function\r\n    const ai = new GoogleGenAI({ apiKey });\r\n\r\n    const prompt = `You are an expert India real estate investment advisor. Analyze the investment potential for ${stateName} state.\r\n\r\nIMPORTANT: Use PLAIN TEXT ONLY. Do NOT use markdown formatting symbols like **, *, #, or other markup. Write clean, readable text without any formatting characters.\r\n\r\n**USE GOOGLE SEARCH** for the latest Q4 2024 / Q1 2025 data on:\r\n- Property price trends and YoY appreciation rates (2023-2024)\r\n- Recent infrastructure project announcements\r\n- IT parks, SEZ, and business hub developments\r\n- RERA compliance status and state regulations\r\n- Stamp duty rates and circle rates\r\n- Government housing schemes (PMAY, Smart Cities, AMRUT)\r\n- Fastest growing cities by price appreciation\r\n\r\n**USE GOOGLE MAPS** to identify:\r\n- Metro/railway connectivity for major cities\r\n- Proximity to IT hubs, airports, business districts\r\n- Upcoming metro lines and infrastructure corridors\r\n\r\n**Analysis Requirements:**\r\n\r\n1. **Investment Score (1-100):** Based on infrastructure, economic growth, property appreciation, rental yields, and regulatory environment.\r\n\r\n2. **Market Summary:** 2-3 sentences covering current market conditions, recent price trends, and growth drivers.\r\n\r\n3. **Top Cities (3-5):** Select cities with best overall investment potential. For EACH city provide:\r\n   - Name\r\n   - Tier classification (Tier 1/2/3) with justification\r\n   - Growth potential (High/Moderate/Stable) based on upcoming projects\r\n   - Average price per sq.ft (‚Çπ) - mention area type (e.g., \"‚Çπ5,500 in prime localities\")\r\n   - Description: Why invest? Include proximity to IT hubs, metro stations, rental yield potential, infrastructure access\r\n\r\n4. **Fastest Growing Cities (Top 3):** Cities with highest price appreciation in ${stateName}:\r\n   - City name\r\n   - YoY growth rate (%) for 2023-2024\r\n   - Reason for rapid growth (new metro, IT park, airport expansion, smart city status, etc.)\r\n\r\n5. **Market Trends (3-5 key trends):**\r\n   - Overall state price appreciation % (YoY 2023-2024)\r\n   - Emerging micro-markets and localities\r\n   - Demand shifts (residential vs commercial)\r\n   - Impact of new infrastructure projects\r\n   - Rental yield trends and investment preferences\r\n\r\n6. **Infrastructure Projects (3-5 major projects):**\r\n   - Include project name, timeline/completion year, and investment impact\r\n   - Focus on: metro lines, expressways, airports, IT parks, smart city initiatives, industrial corridors\r\n\r\n**CRITICAL:**\r\n1. Return ONLY a valid JSON object. No explanatory text before or after.\r\n2. All text in descriptions, trends, and reasons must be PLAIN TEXT without markdown symbols (**, *, #, etc.)\r\n\r\nJSON Format:\r\n{\r\n  \"stateName\": \"${stateName}\",\r\n  \"investmentScore\": <number 1-100>,\r\n  \"summary\": \"<comprehensive 2-3 sentence market overview>\",\r\n  \"topCities\": [\r\n    {\r\n      \"name\": \"<city name>\",\r\n      \"tier\": \"Tier 1\" | \"Tier 2\" | \"Tier 3\",\r\n      \"growthPotential\": \"High\" | \"Moderate\" | \"Stable\",\r\n      \"avgPriceSqFt\": \"‚ÇπXXXX in <area type>\",\r\n      \"description\": \"<investment rationale with specific factors>\"\r\n    }\r\n  ],\r\n  \"fastestGrowingCities\": [\r\n    {\r\n      \"name\": \"<city name>\",\r\n      \"growthRate\": \"<XX% YoY 2023-2024>\",\r\n      \"reason\": \"<why it's growing fast>\"\r\n    }\r\n  ],\r\n  \"marketTrends\": [\"<specific trend with data/percentages>\", \"...\"],\r\n  \"infrastructureProjects\": [\"<project name with timeline and impact>\", \"...\"]\r\n}\r\n\r\nReturn ONLY the JSON object, nothing else.`;\r\n\r\n    const config = {\r\n      tools: [{ googleSearch: {} }],\r\n    };\r\n\r\n    const response = await ai.models.generateContent({\r\n      model: \"gemini-3-pro-preview\",\r\n      contents: prompt,\r\n      config,\r\n    });\r\n\r\n    const text = response.text;\r\n    if (!text) {\r\n      throw new Error(\"No response from AI\");\r\n    }\r\n\r\n    // Enhanced JSON extraction - handles text before/after JSON and markdown blocks\r\n    let jsonText = text.trim();\r\n\r\n    // Remove all markdown code blocks (```json or ``` anywhere in the text)\r\n    jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\r\n\r\n    // Find the actual JSON object by locating the first { and last }\r\n    const firstBrace = jsonText.indexOf('{');\r\n    const lastBrace = jsonText.lastIndexOf('}');\r\n\r\n    if (firstBrace === -1 || lastBrace === -1 || firstBrace >= lastBrace) {\r\n      console.error('‚ùå No valid JSON object found in response');\r\n      console.error('Full response (first 500 chars):', text.substring(0, 500));\r\n      throw new Error('AI returned invalid JSON format - no JSON object found');\r\n    }\r\n\r\n    // Extract just the JSON object\r\n    jsonText = jsonText.substring(firstBrace, lastBrace + 1).trim();\r\n\r\n    try {\r\n      const data = JSON.parse(jsonText);\r\n      console.log('‚úÖ Successfully parsed state analysis for:', stateName);\r\n      return NextResponse.json(data);\r\n    } catch (parseError) {\r\n      console.error('‚ùå Failed to parse JSON');\r\n      console.error('Extracted JSON (first 500 chars):', jsonText.substring(0, 500));\r\n      console.error('Full AI response (first 500 chars):', text.substring(0, 500));\r\n      console.error('Parse error:', parseError);\r\n      throw new Error('AI returned invalid JSON format - parse failed');\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"State Analysis Error:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'Failed to analyze state' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,QAAQ,IAAI;QAExC,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,IAAI;QAE7C,QAAQ,GAAG,CAAC,oCAAoC;QAChD,QAAQ,GAAG,CAAC,sBAAsB,SAAS,CAAC,gBAAgB,EAAE,OAAO,MAAM,CAAC,CAAC,CAAC,GAAG;QAEjF,IAAI,CAAC,QAAQ;YACX,OAAO,oLAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkB,GAC3B;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,WAAW;YACd,OAAO,oLAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,6CAA6C;QAC7C,MAAM,KAAK,IAAI,gNAAW,CAAC;YAAE;QAAO;QAEpC,MAAM,SAAS,CAAC,6FAA6F,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iFA+B5C,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;gBAsB7E,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;0CAuBc,CAAC;QAEvC,MAAM,SAAS;YACb,OAAO;gBAAC;oBAAE,cAAc,CAAC;gBAAE;aAAE;QAC/B;QAEA,MAAM,WAAW,MAAM,GAAG,MAAM,CAAC,eAAe,CAAC;YAC/C,OAAO;YACP,UAAU;YACV;QACF;QAEA,MAAM,OAAO,SAAS,IAAI;QAC1B,IAAI,CAAC,MAAM;YACT,MAAM,IAAI,MAAM;QAClB;QAEA,gFAAgF;QAChF,IAAI,WAAW,KAAK,IAAI;QAExB,wEAAwE;QACxE,WAAW,SAAS,OAAO,CAAC,eAAe,IAAI,OAAO,CAAC,WAAW;QAElE,iEAAiE;QACjE,MAAM,aAAa,SAAS,OAAO,CAAC;QACpC,MAAM,YAAY,SAAS,WAAW,CAAC;QAEvC,IAAI,eAAe,CAAC,KAAK,cAAc,CAAC,KAAK,cAAc,WAAW;YACpE,QAAQ,KAAK,CAAC;YACd,QAAQ,KAAK,CAAC,oCAAoC,KAAK,SAAS,CAAC,GAAG;YACpE,MAAM,IAAI,MAAM;QAClB;QAEA,+BAA+B;QAC/B,WAAW,SAAS,SAAS,CAAC,YAAY,YAAY,GAAG,IAAI;QAE7D,IAAI;YACF,MAAM,OAAO,KAAK,KAAK,CAAC;YACxB,QAAQ,GAAG,CAAC,6CAA6C;YACzD,OAAO,oLAAY,CAAC,IAAI,CAAC;QAC3B,EAAE,OAAO,YAAY;YACnB,QAAQ,KAAK,CAAC;YACd,QAAQ,KAAK,CAAC,qCAAqC,SAAS,SAAS,CAAC,GAAG;YACzE,QAAQ,KAAK,CAAC,uCAAuC,KAAK,SAAS,CAAC,GAAG;YACvE,QAAQ,KAAK,CAAC,gBAAgB;YAC9B,MAAM,IAAI,MAAM;QAClB;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,oLAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAA0B,GACpD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}