{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ES/Desktop/2025/EstateIQIndia/app/api/property-valuation/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { GoogleGenAI } from \"@google/genai\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { location, propertyType, details, userLat, userLng } = await request.json();\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY || '';\r\n\r\n    console.log('ðŸ  Property valuation requested for:', location);\r\n    console.log('ðŸ”‘ API Key Status:', apiKey ? `Loaded (length: ${apiKey.length})` : 'âŒ EMPTY');\r\n\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: 'API Key missing' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    if (!location || !propertyType) {\r\n      return NextResponse.json(\r\n        { error: 'Location and property type are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Initialize GoogleGenAI inside the function\r\n    const ai = new GoogleGenAI({ apiKey });\r\n\r\n    const prompt = `\r\n      Analyze real estate investment for a ${propertyType} in ${location}, India.\r\n      ${details ? `Property details: ${details}` : ''}\r\n\r\n      Provide a comprehensive analysis including:\r\n\r\n      ## Price Estimation\r\n      - Current market price range (â‚¹ per sq.ft or total price)\r\n      - Comparison with nearby areas\r\n      - Recent price trends in the location\r\n\r\n      ## Location Analysis\r\n      Using Google Search, identify:\r\n      - Nearby schools, colleges, and educational institutions\r\n      - Healthcare facilities (hospitals, clinics)\r\n      - Public transport connectivity (metro, bus, railway)\r\n      - Shopping centers, malls, markets\r\n      - Parks, recreational facilities\r\n      - Distance from major landmarks/IT hubs\r\n\r\n      ## Investment Potential\r\n      - Growth factors (upcoming infrastructure, IT parks, metro lines)\r\n      - Rental yield potential\r\n      - Capital appreciation forecast (3-5 years)\r\n      - Risk factors to consider\r\n\r\n      ## Confidence Score\r\n      Rate your analysis confidence: Low/Medium/High\r\n\r\n      Use Google Search for latest price trends and location amenities data.\r\n      Format the response in clear markdown with sections.\r\n    `;\r\n\r\n    const config = {\r\n      tools: [{ googleSearch: {} }],\r\n    };\r\n\r\n    const response = await ai.models.generateContent({\r\n      model: \"gemini-3-pro-preview\",\r\n      contents: prompt,\r\n      config,\r\n    });\r\n\r\n    const text = response.text;\r\n    if (!text) {\r\n      throw new Error(\"No response from AI\");\r\n    }\r\n\r\n    // Clean markdown formatting symbols\r\n    const cleanMarkdown = (text: string): string => {\r\n      return text\r\n        .replace(/\\*\\*/g, '')        // Remove bold markers (**)\r\n        .replace(/\\*/g, '')          // Remove italic markers (*)\r\n        .replace(/^#{1,6}\\s+/gm, '') // Remove heading markers (# ## ###)\r\n        .replace(/`/g, '')           // Remove code markers (`)\r\n        .trim();\r\n    };\r\n\r\n    const cleanedText = cleanMarkdown(text);\r\n\r\n    const groundingChunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];\r\n\r\n    // Enhanced extraction functions\r\n    const extractSection = (text: string, keyword: string): string[] => {\r\n      const lines = text.split('\\n');\r\n      const items: string[] = [];\r\n      let inSection = false;\r\n\r\n      for (const line of lines) {\r\n        const trimmedLine = line.trim();\r\n\r\n        // Check if this line contains the keyword (case-insensitive, handle markdown headers)\r\n        if (trimmedLine.toLowerCase().includes(keyword.toLowerCase())) {\r\n          inSection = true;\r\n          continue;\r\n        }\r\n\r\n        // If in section, extract bullet points\r\n        if (inSection) {\r\n          // Check for bullet points (-, *, â€¢)\r\n          if (trimmedLine.startsWith('-') || trimmedLine.startsWith('*') || trimmedLine.startsWith('â€¢')) {\r\n            const cleaned = trimmedLine.substring(1).trim();\r\n            if (cleaned) items.push(cleaned);\r\n          }\r\n          // Stop at next section header\r\n          else if (trimmedLine.startsWith('#') || (trimmedLine.startsWith('##') && !trimmedLine.toLowerCase().includes(keyword.toLowerCase()))) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      return items;\r\n    };\r\n\r\n    // Extract sections\r\n    const nearbyAmenities = extractSection(text, 'location analysis');\r\n    const growthFactors = extractSection(text, 'growth factor');\r\n    const riskFactors = extractSection(text, 'risk factor');\r\n\r\n    // Extract categorized location data\r\n    const schools = extractSection(text, 'school') || extractSection(text, 'education');\r\n    const hospitals = extractSection(text, 'hospital') || extractSection(text, 'healthcare');\r\n    const transport = extractSection(text, 'transport') || extractSection(text, 'connectivity');\r\n    const shopping = extractSection(text, 'shopping') || extractSection(text, 'mall');\r\n    const parks = extractSection(text, 'park') || extractSection(text, 'recreation');\r\n\r\n    // Extract price range if mentioned\r\n    const priceMatch = text.match(/â‚¹[\\d,]+-?[\\d,]*/g);\r\n    const estimatedPriceRange = priceMatch ? priceMatch[0] : \"See detailed analysis\";\r\n\r\n    // Extract confidence score\r\n    let confidenceScore = \"Medium\";\r\n    if (text.toLowerCase().includes('high confidence') || text.toLowerCase().includes('confidence: high')) {\r\n      confidenceScore = \"High\";\r\n    } else if (text.toLowerCase().includes('low confidence') || text.toLowerCase().includes('confidence: low')) {\r\n      confidenceScore = \"Low\";\r\n    }\r\n\r\n    return NextResponse.json({\r\n      estimatedPriceRange,\r\n      confidenceScore,\r\n      locationAnalysis: cleanedText,\r\n      nearbyAmenities,\r\n      growthFactors,\r\n      riskFactors,\r\n      categorizedAmenities: {\r\n        schools,\r\n        hospitals,\r\n        transport,\r\n        shopping,\r\n        parks\r\n      },\r\n      groundingChunks\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Valuation Error:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'Failed to analyze property' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}